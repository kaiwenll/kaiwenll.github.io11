 # 壁纸不显示问题总结

> + 通过日志分析 ``` W/WallpaperManager(pid):WallpaperService not running```初步定位是服务没有开启的原因
>
> + 在 ***/system/build.prop*** 中增加 ***sys.wallpaper.enable=true*** 之后继续追查 log 
>
>   > + 首先开机之后查看服务状态是正确的
>   >
>   >   ```
>   >   root@p201_iptv:/ # getprop | grep wallpaper
>   >   [sys.wallpaper.enable]: [true]
>   >   ```
>   >
>   > + 发现log中还是会打印``` W/WallpaperManager(pid):WallpaperService not running```
>
>   ***
>
> + 然后代码追定位到 ***frameworks/base/services/java/com/android/server/SystemServer.java***
>
>   *honestly speaking , I don't know why direct here , but chaoyang bro let me do that.*
>
>   + #### 搜索 Wallpaper 找到系统服务添加wallpaper的代码
>
>     ```
>     if (!disableNonCoreServices && context.getResources().getBoolean(
>                             R.bool.config_enableWallpaperService) &&
>                             SystemProperties.getBoolean("sys.wallpaper.enable", false)) {
>                     try {
>                         Slog.i(TAG, "Wallpaper Service");
>                         if (!headless) {               
>                             wallpaper = new WallpaperManagerService(context);
>                             ServiceManager.addService(Context.WALLPAPER_SERVICE, wallpaper);
>                         }         
>                     } catch (Throwable e) {        
>                         reportWtf("starting Wallpaper Service", e);
>                     }
>                 }
>     
>     ```
>
>     #### 继续查找，***initAndLoop()*** 方法里，创建了一个对象 *wallpaperF*
>
>     ```
>     final WallpaperManagerService wallpaperF = wallpaper;
>     ```
>
>     #### 这里会检测这个标志位，如果不为1，就创建一个 systemUi 线程
>
>     ```
>                     Thread th = new Thread("test") {
>                         public void run() {
>                             try {
>                                 Thread.sleep(3000);
>                             } catch (Exception e) {}
>                             if (!headless) {
>                                 startSystemUi(contextF);
>                             }
>                         }
>                     };
>                     if (SystemProperties.getBoolean("sys.wallpaper.enable", false))
>                         th.start();
>     
>     ```
>
>     
>
>     ####  ***wallpaperF.systemRunning（）*** 
>
>     ```
>     
>                     try {
>                         if (wallpaperF != null) wallpaperF.systemRunning();
>                     } catch (Throwable e) {        
>                         reportWtf("Notifying WallpaperService running", e);
>                     }
>                     Slog.i(TAG, "BootStage Notifying WallpaperService running");
>     
>     ```
>
>     
>
>     #### 继续追到 ***WallpaperManagerService.java*** 
>
>     
>
>     ```
>         /**  
>          * Name of the component used to display bitmap wallpapers from either the gallery or
>          * built-in wallpapers.
>          */
>         static final ComponentName IMAGE_WALLPAPER = new ComponentName("com.android.systemui",
>                 "com.android.systemui.ImageWallpaper");
>     ```
>
>     
>
>     

